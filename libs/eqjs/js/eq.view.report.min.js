(function(n,t){var i=t.EQ=t.EQ||{},r=function(){return typeof google!="undefined"&&typeof google.visualization!="undefined"},u=function(){return r()&&typeof google.visualization.PieChart!="undefined"};i.view.report={_resultPanel:null,_sqlPanel:null,_clearQueryButton:null,_loadQueryButton:null,_saveQueryButton:null,_executeQueryButton:null,_exportButtons:null,_gridClass:"",_funcs:{},_findControlById:function(t){var i=n("#"+t);return i.length==0&&(i=null),i},init:function(r){var f,e,o,s,h,c,l,a,v,y,u,p;if(r=r||t.easyQueryViewSettings||{},i.view.applyCommonOptions(r),f=r.resultPanelId||"ResultPanel",this._resultPanel=this._findControlById(f),e=r.sqlPanelId||"SqlPanel",this._sqlPanel=this._findControlById(e),o=r.clearReportButtonId||"ClearReportButton",this._clearReportButton=this._findControlById(o),s=r.newReportButtonId||"NewReportButton",this._newReportButton=this._findControlById(s),h=r.loadReportButtonId||"LoadReportButton",this._loadReportButton=this._findControlById(h),c=r.saveReportButtonId||"SaveReportButton",this._saveReportButton=this._findControlById(c),l=r.removeReportButtonId||"RemoveReportButton",this._removeReportButton=this._findControlById(l),a=r.updateReportButtonId||"UpdateReportButton",this._updateReportButton=this._findControlById(a),v=r.resultCountSpanId||"ResultCount",this._resultCountSpan=this._findControlById(v),y=r.exportButtonsId||"ResultExportButtons",this._exportButtons=this._findControlById(y),this._gridClass=r.gridClass||"table table-striped table-condensed",this._reportListPlaceholder=n("#ReportList"),typeof r.rebuildOnReportChange=="undefined"&&(r.rebuildOnReportChange=!0),typeof r.syncReportOnChange=="undefined"&&(r.syncReportOnChange=!0),this.showChart=typeof r.showChart!="undefined"?r.showChart:!0,this.pagingOptions=r.paging,this.reports=[],u=this,i.client.init(),this._funcs.clearReportButtonClick||(this._funcs.clearReportButtonClick=function(){u._clearErrors();u._exportButtons&&u._exportButtons.hide();u._resultCountSpan&&u._resultCountSpan.hide();u._clearSqlPanel();i.client.clearQuery()}),this._clearReportButton){this._clearReportButton.off("click",this._funcs.clearReportButtonClick);this._clearReportButton.on("click",this._funcs.clearReportButtonClick)}if(this._funcs.newReportButtonClick||(this._funcs.newReportButtonClick=function(){u.newReport()}),this._newReportButton){this._newReportButton.off("click",this._funcs.newReportButtonClick);this._newReportButton.on("click",this._funcs.newReportButtonClick)}if(this._funcs.loadReportButtonClick||(this._funcs.loadReportButtonClick=function(){i.client.loadQuery({id:"LastQuery",sucess:function(){u._clearErrors();u._clearResultPanel()},error:u._errorHandler})}),this._loadReportButton){this._loadReportButton.off("click",this._funcs.loadReportButtonClick);this._loadReportButton.on("click",this._funcs.loadReportButtonClick)}if(this._funcs.saveReportButtonClick||(this._funcs.saveReportButtonClick=function(){u.saveCurrentReportAs()}),this._saveReportButton){this._saveReportButton.off("click",this._funcs.saveReportButtonClick);this._saveReportButton.on("click",this._funcs.saveReportButtonClick)}if(this._funcs.removeReportButtonClick||(this._funcs.removeReportButtonClick=function(){u.removeCurrentReport()}),this._removeReportButton){this._removeReportButton.off("click",this._funcs.removeReportButtonClick);this._removeReportButton.on("click",this._funcs.removeReportButtonClick)}if(this._funcs.updateReportButtonClick||(this._funcs.updateReportButtonClick=function(){u.buildAndExecute()}),this._updateReportButton){this._updateReportButton.off("click",this._funcs.updateReportButtonClick);this._updateReportButton.on("click",this._funcs.updateReportButtonClick)}this._funcs.queryChangedHandler||(this._funcs.queryChangedHandler=function(){u._clearSqlPanel();u._clearResultPanel();r.syncReportOnChange&&u.syncReport()});p=i.client.getQuery();p.addChangedCallback(this._funcs.queryChangedHandler);t.setTimeout(function(){i.client.loadQueryList({success:function(t){n.isArray(t)&&(u.reports=t,u.renderReportList())}})},500)},_insertIntoReportList:function(n){this.reports.push(n)},_removeFromReportList:function(n){var t=this._indexOfReportById(n);return t>=0&&this.reports.splice(t,1),t},_indexOfReportById:function(n){for(var t=0;t<this.reports.length;t++)if(this.reports[t].id==n)return t;return-1},renderReportList:function(t){var u,r,f,i;if(this._renderReportPanels(),this._reportListPlaceholder.length>0){for(this._reportListPlaceholder.empty(),t=t||{reportId:this.reports.length>0?this.reports[0].id:null},u=n("<ul class='nav nav-pills nav-stacked'><\/ul>").appendTo(this._reportListPlaceholder),r=0;r<this.reports.length;r++)f=this.reports[r],this._renderReportItemInList(f,u);t.reportId&&this.loadReport(t.reportId);typeof t.reportIndex!="undefined"&&(i=t.reportIndex,i>=this.reports.length&&(i=this.reports.length-1),i<0&&this.reports.length>0&&(i=0),i>=0&&this.loadReport(this.reports[i].id))}},_renderReportPanels:function(){var t=n("#ReportPanel"),i=n("#NoReportPanel");this.reports.length>0?(i.hide(),t.show()):(t.hide(),i.show())},_renderReportItemInList:function(t,i){if(i||(i=this._reportListPlaceholder.find("ul")),i.length!=0){var r=t.name||t.text,u=n("<li data-rid='"+t.id+"'><a href='javascript:void(0)'>"+r+"<\/a><\/li>"),f=this;u.appendTo(i).click(function(){var t=n(this).data("rid");f.loadReport(t)})}},renderCurrentReport:function(){var f=i.client.getQuery(),t,u,r;for(n("#ReportTitle").text(f.getName()),t=n(".columns-panel"),t.empty(),t.append("<strong>Columns:<\/strong> "),u=f.getColumns(),r=0;r<u.length;r++)t.append('<span class="label label-default">'+u[r].caption+"<\/span> ")},setActiveReport:function(n){var t=this._reportListPlaceholder.find("li");t.removeClass("active");t.filter("[data-rid='"+n+"']").addClass("active")},newReport:function(){var n=this,t=prompt("Enter report name","New report");t&&i.client.newQuery({queryName:t,success:function(){var t=i.client.getQuery(),r=t.getId();n._insertIntoReportList({id:r,name:t.getName()});n.renderReportList({reportId:r})}})},loadReport:function(n){if(n){var t=this;i.client.loadQuery({id:n,silent:!1,success:function(){t.buildAndExecute();t.renderCurrentReport()}});this.setActiveReport(n)}},saveCurrentReportAs:function(){var n=this,t=i.client.getQuery(),r=prompt("Enter new report name",t.getName());r&&i.client.saveQuery({query:t,queryName:r,success:function(){var u=i.client.getQuery(),r=u.getId();n.buildAndExecute();n._insertIntoReportList({id:r,name:t.getName()});n.renderReportList({reportId:r});n.setActiveReport(r);n.renderCurrentReport()},error:n._errorHandler})},removeCurrentReport:function(){var r=i.client.getQuery();if(confirm("Remove report '"+r.getName()+"'?")){var n=this,u=i.client.getQuery(),t=u.getId();i.client.removeQuery({queryId:t,success:function(){var i=n._removeFromReportList(t);n.renderReportList({reportIndex:i})}})}},_clearErrorsInPanel:function(n){n&&(n.hasClass("error")&&n.removeClass("error"),n.empty())},_clearErrors:function(){this._clearErrorsInPanel(this._resultPanel);this._clearErrorsInPanel(this._sqlPanel)},_clearSqlPanel:function(){this._sqlPanel&&this._sqlPanel.empty()},_clearResultPanel:function(){this._resultPanel&&this._resultPanel.empty();this._exportButtons&&this._exportButtons.hide()},syncReport:function(){var u=this,t=n("<div><\/div>",{"class":"result-panel loader"}),r=u._sqlPanel;i.client.syncQuery({beforeSend:function(){r&&(r.animate({opacity:"0.5"},200),r.append(t))},success:function(n){var i=n.statement||"";u.renderSqlStatement(i);t.remove()},error:function(n,i){t.remove();alert("Error: "+n+"\n"+i)}})},renderSqlStatement:function(n){var t=this._sqlPanel,i;t&&(this._clearErrorsInPanel(t),t.animate({opacity:1},200),t.prop("tagName")!=="TEXTAREA"&&(t.html('<div class="sql-panel-result"><\/div>'),t=t.find("div")),t.text(n?n:""),i=t.html().replace(/\r\n/g,"<br />").replace(/  /g,"&nbsp;&nbsp;"),t.html(i))},buildAndExecute:function(t){var u=this;t=t||{page:1};var e=i.client.getQuery(),f=n("<div><\/div>",{"class":"result-panel loader"}),r=u._resultPanel;i.client.buildAndExecute({query:e,options:{page:t.page,resultFormat:1},beforeSend:function(){r&&(r.animate({opacity:"0.5"},200),r.html(f))},success:function(t){var o,c,s,l,h,e,a;try{t.statement&&u.renderSqlStatement(t.statement);r&&(r.empty(),t.resultSet&&(t.resultSet.table?o=i.view.renderGridOldStyle(t.resultSet.table):(c=i.view.getDataTableClass(),s=new c(t.resultSet),u.showChart&&(l=n("<div />").addClass("chart-panel").css({float:"right"}).appendTo(r),i.view.drawChart(s,l.get(0))),o=i.view.renderGridByDataTable(s),o.addClass("table table-striped table-condensed")),h=n("<div />").addClass("grid-panel").appendTo(r),h.append(o),u._exportButtons&&u._exportButtons.show(),e=t.paging,e&&e.enabled&&e.pageCount>1&&(a=i.view.renderPageNavigator({pageIndex:e.pageIndex,pageCount:e.pageCount,pageSelectedCallback:function(n){u.buildAndExecute({page:n})},maxButtonCount:u.pagingOptions?u.pagingOptions.maxButtonCount:null,cssClass:u.pagingOptions?u.pagingOptions.cssClass:null}),h.css("height",r.innerHeight()-30),a.appendTo(r)),r.animate({opacity:1},200)));t.resultCount&&(u._resultCountSpan.text(t.resultCount),u._resultCountSpan.show())}finally{f.remove()}},error:function(n,t,i){f.remove();r&&(r.empty(),r.append("<div><\/div>").addClass("error").append("<div>Error during "+i+" request:  <div>"+t+"<\/div><\/div>"))}})}};n(function(){i.view.report.init()})})(jQuery,window);